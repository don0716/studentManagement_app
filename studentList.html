<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width">
  <title>studentManagementApp</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" rel="stylesheet" type="text/css" />
</head>

<body>
  <header class=" py-2">
    <nav class="navbar navbar-expand-lg bg-light">
      <div class="container">
        <p class="navbar-brand">Student Management</p>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <div class="ms-auto d-flex">
            <ul class="navbar-nav">
              <li class="nav-item">
                <a href="index.html" class="nav-link ">Home</a>
              </li>
              <li class="nav-item">
                <a class="nav-link active" href="/studentList.html">Student List</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/addStudent.html">Add Student</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <main class="container">
    <div class="mt-3">
      <h1>Student List</h1>
    </div>

    <div class="text-center mt-2" id="successMessage"></div>

    <div class="mt-3">
      <label class="form-label" for="filterGender">Filter By Gender:</label>
      <select id="filterGender" class="form-select">
        <option value="All">All</option>
        <option value="Male">Male</option>
        <option value="Female">Female</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="mt-4">
      <ul id="displayList" class="list-group"></ul>
    </div>
    

    
  </main>

  <script>
    const filterGender = document.querySelector("#filterGender")
    const displayList = document.querySelector("#displayList")
    const successMessage = document.querySelector("#successMessage")
    const apiUrl = 'https://student-management-Student-neog.replit.app/students'

    const fetchApi = (url, filter) => {
      displayList.innerHTML = `<div class="card bg-success-subtle">
        <div class="text-center">
        <div class="spinner-border mt-1" role="status">
          <span class="visually-hidden">Loading...</span>
        </div></div></div>`

      fetch(url)
      .then(res => res.json())
      .then(data => {
        if(data.length > 0){
          
          displayList.innerHTML = ""
          
          for(let i=0; i<data.length; i++){
            const li = document.createElement("li")
            li.className = 'list-group-item d-flex justify-content-between'
            
            if(filter !== "All"){

                  if(data[i].gender ===  filterGender.value){
                    li.innerHTML = `${data[i].name} - Grade: ${data[i].grade} - Age: ${data[i].age} - Attendance: ${data[i].attendance} - Gender: ${data[i].gender} - Marks: ${data[i].marks} <button id="deleteBtn" data-id=${data[i]._id} class="btn btn-danger btn-sm">Delete</button>`
                      displayList.appendChild(li)
                  }
              
            } else {
              li.innerHTML = `${data[i].name} - Grade: ${data[i].grade} - Age: ${data[i].age} - Attendance: ${data[i].attendance} - Gender: ${data[i].gender} - Marks: ${data[i].marks} <button id="deleteBtn" data-id=${data[i]._id} class="btn btn-danger btn-sm">Delete</button>`
              displayList.appendChild(li)
            }
            
          }
        } else {
          displayList.innerHTML = `<div class="card bg-success-subtle py-2 text-center"><div class='fw-bolder fs-4'>${data.length === 0 ? "Add More Students!" : "There was an Error in fetching Data!"}</div></div>`
        }

        const deleteBtn = document.querySelectorAll('#deleteBtn')
        for(let i=0; i<deleteBtn.length; i++){
          deleteBtn[i].addEventListener("click", getStudentId => {
            successMessage.innerHTML = `<div class="card bg-success-subtle">
              <div class="text-center">
              <div class="spinner-border mt-1" role="status">
                <span class="visually-hidden">Loading...</span>
              </div></div></div>`
            
            const studentId = event.target.getAttribute('data-id')
            
            fetch(`${apiUrl}/${studentId}`, {
              method: 'DELETE'
            }).then(res => res.json())
              .then(data => {
                if(data){
                  console.log(data)
                  successMessage.innerHTML = `<div class="card bg-success-subtle py-2"><div class='fw-bold fs-4'>Student Detail was Deleted Successfully</div></div>`
                  clearMessage(2000)
                  // console.log("FIlter Gender value Inside delete fetch:: ",filterGender.value)
                  fetchApi(apiUrl, filterGender.value)
                } else {
                  successMessage.innerHTML = `<div class="card bg-danger-subtle py-2"><div class='fw-bolder fs-4'>There was an Error in Deleting Data!</div></div>`
                }
              }).catch(e => {
                successMessage.innerHTML =  `<div class="card bg-danger-subtle py-2"><div class='fw-bolder fs-4'>There was an error. ErrorMessage: ${e.message}</div></div>`
              })

            
          })
        }
        
      }).catch(e => {
        displayList.innerHTML = `<div class="card bg-danger-subtle py-2"><div class='fw-bolder fs-4'>There was an error. ErrorMessage: ${e.message}</div></div>`
      })

      
    }

    // console.log("FIlter Gender value:: ",filterGender.value)

    filterGender.addEventListener("change", filterByGender => {
      if(filterGender.value !== "All"){
        fetchApi(apiUrl, filterGender.value)
      } else {
        fetchApi(apiUrl, "All")
      }
    })
    

    const clearMessage = (t) => {
      setTimeout(()=> {
        successMessage.innerHTML = ""
      }, t)
    }



    fetchApi(apiUrl, "All")
  </script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js
"></script>
</body>

</html>